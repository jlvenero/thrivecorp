name: SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Importante para o Sonar analisar o histórico do git

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # Instalação de dependências
      - name: Install Backend Dependencies
        run: npm install --prefix backend

      - name: Install Frontend Dependencies
        run: npm install --prefix frontend

      # --- EXECUÇÃO DOS TESTES ---
      
      # Removido '-- --coverage' pois seu package.json já roda 'jest --coverage'
      # Removido 'continue-on-error' para garantir que o relatório só suba se os testes passarem
      - name: Run Backend Tests & Coverage
        run: npm test --prefix backend

      - name: Run Frontend Tests & Coverage
        run: npm run coverage --prefix frontend

      # --- CORREÇÃO CRÍTICA DE CAMINHOS (FIX PATHS) ---
      # O Jest/Vitest gera caminhos como "src/file.js". 
      # O Sonar na raiz precisa de "frontend/src/file.js".
      - name: Fix Coverage Paths
        run: |
          # Ajusta caminhos do Backend
          if [ -f backend/coverage/lcov.info ]; then
            sed -i 's|SF:|SF:backend/|g' backend/coverage/lcov.info
            echo "Caminhos do Backend corrigidos."
          else
            echo "Backend lcov.info não encontrado. Verifique se os testes passaram."
          fi

          # Ajusta caminhos do Frontend
          if [ -f frontend/coverage/lcov.info ]; then
            sed -i 's|SF:|SF:frontend/|g' frontend/coverage/lcov.info
            echo "Caminhos do Frontend corrigidos."
          else
            echo "Frontend lcov.info não encontrado. Verifique se os testes passaram."
          fi
      # --------------------------------------------------

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=0c0a3332e20c3550b970d04f3135a0dc43f0cfea
            -Dsonar.projectKey=jlvenero_thrivecorp
            -Dsonar.sources=backend,frontend/src
            -Dsonar.exclusions=**/*.test.js,**/*.test.jsx,**/node_modules/**,**/dist/**,**/*.config.js,**/jest.config.js,**/vite.config.js,**/*.test.js,**/*.css
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info